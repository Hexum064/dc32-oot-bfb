#include <stdio.h>
#include <stdlib.h>
#include "string.h"
#include "pico/stdlib.h"
#include "pico/binary_info.h"
#include "pico/multicore.h"
#include "hardware/spi.h"
#include "hardware/irq.h"
#include "hardware/gpio.h"
#include "hardware/timer.h"
#include "hardware/pio.h"
#include "hardware/dma.h"
#include "hardware/adc.h"
#include "hardware/pwm.h"
#include "i2s_32_441.pio.h"
#include "ws2812b.pio.h"

#define ALARM_1_NUM 0
#define ALARM_1_IRQ TIMER_IRQ_0

#define ALARM_2_NUM 1
#define ALARM_2_IRQ TIMER_IRQ_1

#define SAMPLE_RATE 44100
#define BITS_PER_SAMPLE 32
#define SPI_CLK_DIVISOR 90
#define SPI_FREQ (SAMPLE_RATE * BITS_PER_SAMPLE)
#define PICO_CLK_KHZ 133000 // ((SPI_FREQ * SPI_CLK_DIVISOR) / 1000)
#define AUDIO_BUFF_SIZE 1024 //Size of max Ocarina
#define MAX_VOL 254
#define VOL_AVG 8

#define ADC_VOL_GPIO 26

#define I2S_DATA_GPIO 17  
#define I2S_CLK_GPIO 18   
#define I2S_FS_GPIO 19   

#define PWM_LED_0_GPIO 2
#define PWM_LED_1_GPIO 3
#define PWM_LED_2_GPIO 4

#define NOTE_D_GPIO 5
#define NOTE_F_GPIO 6
#define NOTE_A_GPIO 7
#define NOTE_B_GPIO 8
#define NOTE_D2_GPIO 9

#define MODE_GPIO 10

#define MODE_LED_0_GPIO 11
#define MODE_LED_1_GPIO 12

#define RGB_LEDS_GPIO 13

#define PWM_CYCLES_LONG 10000

extern uint8_t song_of_storms[];
extern uint8_t a_loop[];
extern uint8_t b_loop[];
extern uint8_t d_loop[];
extern uint8_t d2_loop[];
extern uint8_t f_loop[];

const uint16_t sineLookupTable[] = {
0x8000, 0x8327, 0x864e, 0x8974, 0x8c98, 0x8fbb, 0x92db, 0x95f8,
0x9911, 0x9c27, 0x9f39, 0xa245, 0xa54c, 0xa84e, 0xab49, 0xae3d,
0xb12a, 0xb410, 0xb6ed, 0xb9c2, 0xbc8e, 0xbf51, 0xc20a, 0xc4b8,
0xc75c, 0xc9f4, 0xcc82, 0xcf03, 0xd178, 0xd3e0, 0xd63c, 0xd88a,
0xdaca, 0xdcfc, 0xdf1f, 0xe134, 0xe33a, 0xe530, 0xe717, 0xe8ed,
0xeab3, 0xec69, 0xee0e, 0xefa2, 0xf124, 0xf295, 0xf3f4, 0xf541,
0xf67b, 0xf7a4, 0xf8b9, 0xf9bc, 0xfaac, 0xfb89, 0xfc53, 0xfd09,
0xfdac, 0xfe3c, 0xfeb8, 0xff20, 0xff74, 0xffb5, 0xffe2, 0xfffa,
0xffff, 0xfff0, 0xffce, 0xff97, 0xff4c, 0xfeee, 0xfe7c, 0xfdf7,
0xfd5d, 0xfcb1, 0xfbf0, 0xfb1d, 0xfa37, 0xf93d, 0xf831, 0xf712,
0xf5e0, 0xf49c, 0xf346, 0xf1df, 0xf065, 0xeeda, 0xed3e, 0xeb90,
0xe9d2, 0xe804, 0xe625, 0xe437, 0xe239, 0xe02c, 0xde0f, 0xdbe5,
0xd9ab, 0xd764, 0xd510, 0xd2ae, 0xd03f, 0xcdc4, 0xcb3d, 0xc8aa,
0xc60b, 0xc362, 0xc0ae, 0xbdf1, 0xbb29, 0xb859, 0xb580, 0xb29e,
0xafb5, 0xacc4, 0xa9cc, 0xa6ce, 0xa3c9, 0xa0bf, 0x9db0, 0x9a9d,
0x9785, 0x946a, 0x914b, 0x8e2a, 0x8b06, 0x87e1, 0x84bb, 0x8194,
0x7e6c, 0x7b45, 0x781f, 0x74fa, 0x71d6, 0x6eb5, 0x6b96, 0x687b,
0x6563, 0x6250, 0x5f41, 0x5c37, 0x5932, 0x5634, 0x533c, 0x504b,
0x4d62, 0x4a80, 0x47a7, 0x44d7, 0x420f, 0x3f52, 0x3c9e, 0x39f5,
0x3756, 0x34c3, 0x323c, 0x2fc1, 0x2d52, 0x2af0, 0x289c, 0x2655,
0x241b, 0x21f1, 0x1fd4, 0x1dc7, 0x1bc9, 0x19db, 0x17fc, 0x162e,
0x1470, 0x12c2, 0x1126, 0xf9b, 0xe21, 0xcba, 0xb64, 0xa20,
0x8ee, 0x7cf, 0x6c3, 0x5c9, 0x4e3, 0x410, 0x34f, 0x2a3,
0x209, 0x184, 0x112, 0xb4, 0x69, 0x32, 0x10, 0x01,
0x06, 0x1e, 0x4b, 0x8c, 0xe0, 0x148, 0x1c4, 0x254,
0x2f7, 0x3ad, 0x477, 0x554, 0x644, 0x747, 0x85c, 0x985,
0xabf, 0xc0c, 0xd6b, 0xedc, 0x105e, 0x11f2, 0x1397, 0x154d,
0x1713, 0x18e9, 0x1ad0, 0x1cc6, 0x1ecc, 0x20e1, 0x2304, 0x2536,
0x2776, 0x29c4, 0x2c20, 0x2e88, 0x30fd, 0x337e, 0x360c, 0x38a4,
0x3b48, 0x3df6, 0x40af, 0x4372, 0x463e, 0x4913, 0x4bf0, 0x4ed6,
0x51c3, 0x54b7, 0x57b2, 0x5ab4, 0x5dbb, 0x60c7, 0x63d9, 0x66ef,
0x6a08, 0x6d25, 0x7045, 0x7368, 0x768c, 0x79b2, 0x7cd9};


typedef struct audio_buff_t {
    uint32_t buffer[AUDIO_BUFF_SIZE * 2];
    uint32_t length;
} audio_buff_t;

audio_buff_t audio_buffs[2];

//Maybe create a struct
uint8_t * current_sample;
uint32_t current_sample_len;
uint32_t current_sample_offset = 0;
uint8_t audio_dma_channel;
uint8_t current_volume = 0;
uint8_t current_buff_index = 0;
uint16_t vol_running_avg[VOL_AVG];
uint8_t vol_avg_index = 0;

dma_channel_config audio_dma_config;
dma_channel_config pwm_0_dma_config;
dma_channel_config pwm_1_dma_config;
dma_channel_config pwm_2_dma_config;

int main()
{
    while(1)
    {}
}